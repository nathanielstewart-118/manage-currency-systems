<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Currencies Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" referrerpolicy="no-referrer"/>
  <style>
    body {
      background-color: #f8f9fa;
    }
    .card-custom {
      transition: transform 0.2s ease-in-out;
    }
    .card-custom:hover {
      transform: scale(1.02);
    }
    div.dataTables_wrapper div.dataTables_paginate ul.pagination {
      margin-bottom: 1rem;
    }
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }
    .btn-action {
      padding: 0.25rem 0.5rem;
    }
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    .notification-toast {
      min-width: 300px;
    }
  </style>
</head>
<body>

<!-- Toast Container for Notifications -->
<div class="toast-container"></div>

<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Currencies Management</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCurrencyModal">
      <i class="fas fa-plus me-2"></i>Add New Currency
    </button>
  </div>

  <div class="card text-white border-primary mb-3">
    <div class="card-header text-primary">Currencies List</div>
    <div class="card-body">
      <table id="currencies-table" class="table table-striped" style="width:100%">
        <thead>
          <tr>
            <th>No</th>
            <th>Unit</th>
            <th>Name</th>
            <th>URL</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="currencies-table-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add Currency Modal -->
<div class="modal fade" id="addCurrencyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Currency</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addCurrencyForm">
          <div class="mb-3">
            <label for="unit" class="form-label">Unit</label>
            <input type="text" class="form-control" id="unit" required>
          </div>
          <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input type="text" class="form-control" id="name" required>
          </div>
          <div class="mb-3">
            <label for="url" class="form-label">URL</label>
            <input type="url" class="form-control" id="url" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="handleAddCurrency()">Save Currency</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Currency Modal -->
<div class="modal fade" id="editCurrencyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Currency</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editCurrencyForm">
          <input type="hidden" id="editCurrencyId">
          <div class="mb-3">
            <label for="editUnit" class="form-label">Unit</label>
            <input type="text" class="form-control" id="editUnit" required>
          </div>
          <div class="mb-3">
            <label for="editName" class="form-label">Name</label>
            <input type="text" class="form-control" id="editName" required>
          </div>
          <div class="mb-3">
            <label for="editUrl" class="form-label">URL</label>
            <input type="url" class="form-control" id="editUrl" required>
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editDescription" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="handleUpdateCurrency()">Update Currency</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this currency? This action cannot be undone.</p>
        <input type="hidden" id="deleteCurrencyUnit">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS and basic logic -->
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
const apiEndPoint = "http://www.48v.me/~mains/cgi-bin/admin.py";
let currenciesTable;

// Notification system
function showNotification(message, type = 'success') {
  const toastContainer = document.querySelector('.toast-container');
  const toastId = 'toast-' + Date.now();
  
  const toastHtml = `
    <div id="${toastId}" class="toast notification-toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-${type === 'success' ? 'success' : 'danger'} text-white">
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
        <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        ${message}
      </div>
    </div>
  `;
  
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  const toastElement = document.getElementById(toastId);
  const toast = new bootstrap.Toast(toastElement, {
    autohide: true,
    delay: 3000
  });
  
  toast.show();
  
  // Remove the toast element after it's hidden
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

document.addEventListener("DOMContentLoaded", () => {
  loadCurrencies();
});

function loadCurrencies() {
  const formData = new FormData();
  formData.append("command", "get_currencies");
  
  fetch(apiEndPoint, {
    method: "POST",
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    displayTable(data.data.currencies);
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Failed to load currencies. Please try again.', 'error');
  });
}

function displayTable(data) {
  if ($.fn.DataTable.isDataTable('#currencies-table')) {
    $('#currencies-table').DataTable().destroy();
  }
  
  $('#currencies-table-tbody').empty();
  
  data.forEach((currency, index) => {
    const row = `
      <tr>
        <td>${index + 1}</td>
        <td>${currency.unit}</td>
        <td>${currency.name}</td>
        <td>${currency.url}</td>
        <td>${currency.description || ''}</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-primary btn-action" onclick="handleEdit(${JSON.stringify(currency).replace(/"/g, '&quot;')})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger btn-action" onclick="handleDelete('${currency.unit}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
    $('#currencies-table-tbody').append(row);
  });

  currenciesTable = $('#currencies-table').DataTable({
    responsive: true,
    pagingType: 'full_numbers',
    lengthMenu: [5, 10, 25, 50, 100],
    order: [[0, 'asc']],
    dom: 'Bfrtip',
    buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
  });
}

function handleAddCurrency() {
  const currencyData = {
    unit: $('#unit').val(),
    name: $('#name').val(),
    url: $('#url').val(),
    description: $('#description').val()
  };

  const formData = new FormData();
  formData.append("command", "add_currency");
  formData.append("data", JSON.stringify(currencyData));

  fetch(apiEndPoint, {
    method: "POST",
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      $('#addCurrencyModal').modal('hide');
      $('#addCurrencyForm')[0].reset();
      loadCurrencies();
      showNotification('Currency added successfully!');
    } else {
      showNotification(data.message || 'Error adding currency', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Failed to add currency. Please try again.', 'error');
  });
}

function handleEdit(currency) {
  $('#editCurrencyId').val(currency.unit);
  $('#editUnit').val(currency.unit);
  $('#editName').val(currency.name);
  $('#editUrl').val(currency.url);
  $('#editDescription').val(currency.description);
  $('#editCurrencyModal').modal('show');
}

function handleUpdateCurrency() {
  const currencyData = {
    unit: $('#editUnit').val(),
    name: $('#editName').val(),
    url: $('#editUrl').val(),
    description: $('#editDescription').val()
  };

  const formData = new FormData();
  formData.append("command", "update_currency");
  formData.append("data", JSON.stringify(currencyData));

  fetch(apiEndPoint, {
    method: "POST",
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      $('#editCurrencyModal').modal('hide');
      loadCurrencies();
      showNotification('Currency updated successfully!');
    } else {
      showNotification(data.message || 'Error updating currency', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Failed to update currency. Please try again.', 'error');
  });
}

function handleDelete(unit) {
  $('#deleteCurrencyUnit').val(unit);
  $('#deleteConfirmModal').modal('show');
}

function confirmDelete() {
  const unit = $('#deleteCurrencyUnit').val();
  const formData = new FormData();
  formData.append("command", "delete_currency");
  formData.append("unit", unit);

  fetch(apiEndPoint, {
    method: "POST",
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      $('#deleteConfirmModal').modal('hide');
      loadCurrencies();
      showNotification('Currency deleted successfully!');
    } else {
      showNotification(data.message || 'Error deleting currency', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Failed to delete currency. Please try again.', 'error');
  });
}
</script>

</body>
</html> 